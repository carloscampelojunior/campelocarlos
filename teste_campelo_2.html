<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Comparador estilo Juxtapose ‚Äì Upload, Dropbox, Labels, Filtros</title>

<!-- ===================== TEMA / ESTILOS ===================== -->
<style>
  :root{
    --bg:#0f172a; --panel:#0b1220; --line:#1f2937; --muted:#94a3b8;
    --text:#e5e7eb; --accent:#22d3ee; --accent-2:#38bdf8;
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#0b1220,#0a1020 60%,#0b1220);color:var(--text);font:500 15px/1.42 system-ui,Segoe UI,Roboto,Arial}
  header{padding:16px 20px;border-bottom:1px solid var(--line);display:flex;gap:12px;align-items:center}
  header h1{margin:0;font-size:18px}
  .badge{font-size:12px;border:1px solid #334155;border-radius:999px;padding:2px 8px;color:#cbd5e1}
  main{display:grid;grid-template-columns:330px 1fr;min-height:calc(100dvh - 57px)}
  @media (max-width:1000px){main{grid-template-columns:1fr}}
  aside{border-right:1px solid var(--line);padding:14px;display:flex;flex-direction:column;gap:14px}
  @media (max-width:1000px){aside{border-right:none;border-bottom:1px solid var(--line)}}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:12px}
  .card h3{margin:0 0 8px 0;font-size:14px;color:#cbd5e1;letter-spacing:.2px}
  .drop{border:1.5px dashed #2b3b55;border-radius:12px;padding:14px;text-align:center;background:#081225}
  .drop.dragover{border-color:var(--accent);background:#07101f}
  .drop input{display:none}
  .btn{background:#0e1a30;border:1px solid #22314a;color:#e2e8f0;padding:8px 10px;border-radius:10px;cursor:pointer}
  .btn:hover{border-color:#2e476f}
  input[type="text"], select{
    width:100%;padding:8px 10px;border-radius:10px;border:1px solid #22314a;background:#0c1628;color:#e5e7eb;outline:none
  }
  input[type="text"]:focus, select:focus{border-color:var(--accent-2);box-shadow:0 0 0 3px #38bdf833}
  .grid{display:grid;gap:8px}
  .grid.cols-2{grid-template-columns:1fr 1fr}
  .thumbs{display:grid;grid-template-columns:repeat(auto-fill,minmax(90px,1fr));gap:8px;max-height:240px;overflow:auto}
  .thumb{position:relative;border-radius:10px;overflow:hidden;border:1px solid var(--line);background:#0a1429}
  .thumb img{width:100%;height:72px;object-fit:cover;display:block}
  .thumb .meta{padding:6px;font-size:12px;color:#cbd5e1;border-top:1px solid var(--line)}
  .thumb .edit{position:absolute;top:6px;right:6px;font-size:11px;background:#0b1220bb;border:1px solid #243043;padding:2px 6px;border-radius:8px;cursor:pointer}
  /* Stage */
  .stage-wrap{padding:16px}
  .stage{
    position:relative;max-width:1100px;margin:0 auto;border:1px solid var(--line);border-radius:16px;overflow:hidden;background:#0a1220;
    aspect-ratio:16/9;touch-action:none;
  }
  .layer{position:absolute;inset:0}
  .layer img{width:100%;height:100%;object-fit:contain;background:#0b1120}
  /* M√°scara horizontal (estilo Juxtapose: barra vertical desliza no eixo X) */
  .left-mask{position:absolute;inset:0;overflow:hidden;pointer-events:none}
  .left-mask-inner{position:absolute;inset:0}
  .left-mask img{position:absolute;inset:0;width:100%;height:100%;object-fit:contain}
  /* Barra/handle ao estilo Juxtapose */
  .handle{
    position:absolute;top:0;bottom:0;width:2px;background:var(--accent-2);
    box-shadow:0 0 0 1px #06111f,0 0 0 2px #083344 inset;cursor:ew-resize;transform:translateX(-1px);
  }
  .knob{
    position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
    width:44px;height:44px;border-radius:999px;background:#06111f;border:2px solid #0ea5b6;display:grid;place-items:center;
    box-shadow:0 3px 14px #0008, inset 0 0 0 2px #06202e;
  }
  .knob:after{content:"‚óÑ ‚ñ∫";font-size:14px;letter-spacing:2px;color:#a5f3fc}
  /* P√≠lulas de legenda */
  .legend{position:absolute;inset:auto 12px 12px 12px;display:flex;gap:8px;justify-content:space-between;pointer-events:none}
  .pill{padding:4px 8px;border-radius:999px;background:#0e1a30bb;border:1px solid #22314a;font-size:12px}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap}
  .hint{position:absolute;left:12px;top:12px;background:#09152a;border:1px solid #1e2d49;border-radius:10px;padding:6px 8px;font-size:12px;color:#cbd5e1}
</style>

<!-- ===================== DROPBOX CHOOSER ===================== -->
<!-- Substitua SUA_APP_KEY_DROPBOX pelo seu App Key do Dropbox -->
<script
  type="text/javascript"
  src="https://www.dropbox.com/static/api/2/dropins.js"
  id="dropboxjs"
  data-app-key="94yqvjuyij3xqei"></script>
</head>

<body>
<header>
  <h1>Comparador estilo Juxtapose</h1>
  <span class="badge">Barra vertical com knob (‚óÑ ‚ñ∫) + Dropbox</span>
</header>

<main>
  <aside>
    <div class="card">
      <h3>1) Upload de imagens</h3>
      <div id="drop" class="drop" tabindex="0">
        Solte imagens aqui ou
        <label class="btn" for="fileInput">escolha arquivos</label>
        <input id="fileInput" type="file" accept="image/*" multiple>
        <div style="margin-top:6px;font-size:12px;color:var(--muted)">Dica: selecione v√°rias de uma vez.</div>

        <!-- Bot√£o do Dropbox -->
        <div class="toolbar" style="margin-top:8px; display:flex; gap:8px; justify-content:center">
          <button class="btn" type="button" onclick="chooseFromDropbox()">Adicionar do Dropbox</button>
        </div>
      </div>
      <div style="margin-top:10px"><div class="thumbs" id="thumbs"></div></div>
    </div>

    <div class="card">
      <h3>2) Editar metadados</h3>
      <div class="grid cols-2">
        <label>Imagem
          <select id="metaSelect"></select>
        </label>
        <div class="toolbar"><button id="saveMeta" class="btn">Salvar</button></div>
      </div>
      <div class="grid">
        <label>Label <input type="text" id="metaLabel" placeholder="Ex.: Fachada Leste ‚Äì Mar/2025"></label>
        <label>Tags (v√≠rgulas) <input type="text" id="metaTags" placeholder="antes,demoli√ß√£o,loteA"></label>
      </div>
    </div>

    <div class="card">
      <h3>3) Filtros e sele√ß√£o</h3>
      <div class="grid cols-2">
        <label>üîé Filtro Esquerda <input type="text" id="filterLeft" placeholder="busca em label/tags"></label>
        <label>üîé Filtro Direita <input type="text" id="filterRight" placeholder="busca em label/tags"></label>
      </div>
      <div class="grid cols-2" style="margin-top:8px">
        <label>üñºÔ∏è Esquerda (topo) <select id="selectLeft"></select></label>
        <label>üñºÔ∏è Direita (base) <select id="selectRight"></select></label>
      </div>
      <div class="toolbar" style="margin-top:10px">
        <button id="swapBtn" class="btn">‚ÜîÔ∏è Inverter lados</button>
        <button id="resetBtn" class="btn">üß≠ Centralizar</button>
      </div>
    </div>
  </aside>

  <section class="stage-wrap">
    <div class="stage" id="stage" tabindex="0" aria-label="Comparador tipo Juxtapose (arraste a barra)">
      <!-- Base (direita) -->
      <div class="layer" id="baseLayer"><img id="imgRight" alt=""></div>
      <!-- Topo (esquerda) com m√°scara horizontal -->
      <div class="left-mask" id="leftMask">
        <div class="left-mask-inner" id="leftMaskInner"><img id="imgLeft" alt=""></div>
      </div>
      <!-- Handle estilo Juxtapose -->
      <div class="handle" id="handle" style="left:50%">
        <div class="knob" aria-hidden="true"></div>
      </div>
      <!-- Legendas -->
      <div class="legend">
        <span class="pill" id="leftLabel">Esquerda</span>
        <span class="pill" id="rightLabel">Direita</span>
      </div>
      <div class="hint">Arraste ‚óÑ ‚ñ∫ ‚Ä¢ Duplo-clique centraliza ‚Ä¢ Setas do teclado movem 1% (Shift = 5%)</div>
    </div>

    <div class="card" style="margin-top:12px">
      <h3>Dicas r√°pidas</h3>
      <ul style="margin:6px 0 0 18px;color:#9fb0c8">
        <li>Barra vertical ‚Äúestilo Juxtapose‚Äù (move no eixo X).</li>
        <li>Use filtros para reduzir as listas (busca em label/tags).</li>
        <li>Duplo-clique na imagem ou no knob centraliza a barra.</li>
        <li>Teclas ‚óÑ ‚ñ∫ movem a barra em passos de 1% (Shift = 5%).</li>
      </ul>
    </div>
  </section>
</main>

<!-- ===================== L√ìGICA / JS ===================== -->
<script>
(function(){
  /*** Estado ***/
  const state = {
    images: [], // {id, url, label, tags:[]}
    leftId: null,   // camada superior (recortada)
    rightId: null,  // camada base
    pos: 0.5        // 0..1 (0 = barra extrema esquerda; 1 = extrema direita)
  };

  /*** Util ***/
  const $ = s => document.querySelector(s);
  const uid = () => Math.random().toString(36).slice(2,9);

  function renderThumbs(){
    const cont = $('#thumbs');
    cont.innerHTML = '';
    state.images.forEach(img=>{
      const el = document.createElement('div');
      el.className = 'thumb';
      el.innerHTML = `
        <button class="edit" title="Editar">‚úé</button>
        <img src="${img.url}" alt="${img.label||''}">
        <div class="meta">
          <div style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${img.label||'(sem label)'}</div>
          <div style="color:#9fb0c8;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${img.tags.join(', ')}</div>
        </div>
      `;
      el.querySelector('.edit').addEventListener('click', ()=>{
        $('#metaSelect').value = img.id; populateMetaFields(img.id); $('#metaLabel').focus();
      });
      el.addEventListener('click', ()=>{
        $('#metaSelect').value = img.id; populateMetaFields(img.id);
      });
      cont.appendChild(el);
    });
    renderSelectors();
    renderMetaSelect();
  }

  function renderMetaSelect(){
    const sel = $('#metaSelect');
    const cur = sel.value;
    sel.innerHTML = state.images.map(i=>`<option value="${i.id}">${i.label||'(sem label)'} ‚Äî ${i.tags.join(', ')}</option>`).join('');
    if(state.images.length && !state.images.find(i=>i.id===cur)){
      sel.value = state.images[0].id;
    } else sel.value = cur;
    if(sel.value) populateMetaFields(sel.value);
  }

  function populateMetaFields(id){
    const img = state.images.find(i=>i.id===id);
    if(!img) return;
    $('#metaLabel').value = img.label || '';
    $('#metaTags').value = img.tags.join(', ');
  }

  function saveMeta(){
    const id = $('#metaSelect').value;
    const img = state.images.find(i=>i.id===id);
    if(!img) return;
    img.label = $('#metaLabel').value.trim();
    img.tags = $('#metaTags').value.split(',').map(t=>t.trim()).filter(Boolean);
    renderThumbs(); renderSelectors(); updateLegend();
  }

  function filterItems(q){
    q = (q||'').trim().toLowerCase();
    if(!q) return state.images;
    return state.images.filter(i =>
      (i.label||'').toLowerCase().includes(q) || i.tags.some(t=>t.toLowerCase().includes(q))
    );
  }

  function renderSelectors(){
    const leftQ = $('#filterLeft').value||'';
    const rightQ = $('#filterRight').value||'';
    const L = $('#selectLeft'), R = $('#selectRight');
    const leftList = filterItems(leftQ);
    const rightList = filterItems(rightQ);
    const toOpt = arr => arr.map(i=>`<option value="${i.id}">${i.label||'(sem label)'} ‚Äî ${i.tags.join(', ')}</option>`).join('');
    const lp = L.value, rp = R.value;
    L.innerHTML = toOpt(leftList);
    R.innerHTML = toOpt(rightList);
    if(leftList.length){ L.value = leftList.find(i=>i.id===lp)?.id || leftList[0].id; state.leftId = L.value; } else { L.innerHTML = '<option>(sem resultados)</option>'; state.leftId=null; }
    if(rightList.length){ R.value = rightList.find(i=>i.id===rp)?.id || rightList[0].id; state.rightId = R.value; } else { R.innerHTML = '<option>(sem resultados)</option>'; state.rightId=null; }
    updateStage();
  }

  function updateLegend(){
    const left = state.images.find(i=>i.id===state.leftId);
    const right = state.images.find(i=>i.id===state.rightId);
    $('#leftLabel').textContent  = left ? (left.label || 'Esquerda') : 'Esquerda';
    $('#rightLabel').textContent = right ? (right.label|| 'Direita') : 'Direita';
  }

  function updateStage(){
    const left = state.images.find(i=>i.id===state.leftId);
    const right = state.images.find(i=>i.id===state.rightId);
    $('#imgLeft').src  = left  ? left.url  : '';
    $('#imgRight').src = right ? right.url : '';
    updateLegend();
  }

  /*** Slider estilo Juxtapose (corte horizontal com barra vertical) ***/
  function setPosition(p, animate=false){
    state.pos = Math.max(0.02, Math.min(0.98, p));
    const stage = $('#stage');
    const w = stage.clientWidth;
    const x = Math.round(w * state.pos);

    const mask = $('#leftMask');
    // A m√°scara mostra apenas da esquerda at√© X
    mask.style.clipPath = `inset(0 ${Math.max(0,w-x)}px 0 0)`;

    const handle = $('#handle');
    if(animate){
      handle.style.transition = 'left .18s ease, transform .18s ease';
      mask.style.transition = 'clip-path .18s ease';
      setTimeout(()=>{handle.style.transition = ''; mask.style.transition='';}, 200);
    }
    handle.style.left = x + 'px';
  }

  function setPositionFromClientX(clientX){
    const rect = $('#stage').getBoundingClientRect();
    let x = clientX - rect.left;
    x = Math.max(0, Math.min(rect.width, x));
    setPosition(x / rect.width);
  }

  // Upload local
  const drop = $('#drop'), fileInput = $('#fileInput');
  function addFiles(files){
    if(!files?.length) return;
    const arr = Array.from(files);
    let pending = arr.length;
    arr.forEach(file=>{
      if(!file.type.startsWith('image/')){ pending--; return; }
      const reader = new FileReader();
      reader.onload = e=>{
        state.images.push({ id: uid(), url: e.target.result, label: file.name.replace(/\.[^/.]+$/,''), tags: [] });
        pending--;
        if(pending===0){
          renderThumbs();
          if(state.images.length>=2 && (!state.leftId || !state.rightId)){
            state.leftId = state.images[0].id; state.rightId = state.images[1].id;
            renderSelectors(); setPosition(0.5, true);
          }
        }
      };
      reader.readAsDataURL(file);
    });
  }
  drop.addEventListener('dragover', e=>{ e.preventDefault(); drop.classList.add('dragover'); });
  drop.addEventListener('dragleave', ()=> drop.classList.remove('dragover'));
  drop.addEventListener('drop', e=>{ e.preventDefault(); drop.classList.remove('dragover'); addFiles(e.dataTransfer.files); });
  drop.addEventListener('click', ()=> fileInput.click());
  fileInput.addEventListener('change', e=> addFiles(e.target.files));

  // Metadados / filtros / sele√ß√£o
  $('#saveMeta').addEventListener('click', saveMeta);
  $('#metaSelect').addEventListener('change', e=> populateMetaFields(e.target.value));
  $('#filterLeft').addEventListener('input', renderSelectors);
  $('#filterRight').addEventListener('input', renderSelectors);
  $('#selectLeft').addEventListener('change', e=>{ state.leftId=e.target.value; updateStage(); });
  $('#selectRight').addEventListener('change', e=>{ state.rightId=e.target.value; updateStage(); });
  $('#swapBtn').addEventListener('click', ()=>{
    const t = state.leftId; state.leftId = state.rightId; state.rightId = t;
    $('#selectLeft').value = state.leftId || ''; $('#selectRight').value = state.rightId || '';
    updateStage();
  });
  $('#resetBtn').addEventListener('click', ()=> setPosition(0.5, true));

  // Drag/Touch do handle
  const stage = $('#stage'); const handle = $('#handle');
  let dragging = false;
  function startDrag(e){
    dragging = true; document.body.style.userSelect = 'none';
    setPositionFromClientX(e.type==='mousedown' ? e.clientX : e.touches[0].clientX);
  }
  function moveDrag(e){
    if(!dragging) return;
    setPositionFromClientX(e.type.includes('mouse') ? e.clientX : e.touches[0].clientX);
  }
  function endDrag(){ dragging = false; document.body.style.userSelect = ''; }
  handle.addEventListener('mousedown', startDrag);
  handle.addEventListener('touchstart', startDrag, {passive:true});
  window.addEventListener('mousemove', moveDrag);
  window.addEventListener('touchmove', moveDrag, {passive:true});
  window.addEventListener('mouseup', endDrag);
  window.addEventListener('touchend', endDrag);
  // Clique/duplo-clique na √°rea
  stage.addEventListener('mousedown', e=>{
    if(e.target===handle || e.target.closest('.knob')) return;
    setPositionFromClientX(e.clientX);
  });
  stage.addEventListener('dblclick', ()=> setPosition(0.5, true));

  // Teclado: setas ajustam 1% (Shift = 5%)
  stage.addEventListener('keydown', e=>{
    const step = e.shiftKey ? 0.05 : 0.01;
    if(e.key==='ArrowLeft'){ setPosition(state.pos - step, true); }
    if(e.key==='ArrowRight'){ setPosition(state.pos + step, true); }
  });

  // Responsivo
  new ResizeObserver(()=> setPosition(state.pos)).observe(stage);

  // Inicial
  setPosition(0.5);

  // ===================== INTEGRA√á√ÉO DROPBOX CHOOSER =====================
  window.chooseFromDropbox = function(){
    if (!window.Dropbox) {
      alert("Dropbox Chooser n√£o carregou. Verifique sua APP KEY.");
      return;
    }
    Dropbox.choose({
      // Apenas imagens
      extensions: ['.png','.jpg','.jpeg','.webp','.gif','.bmp','.tiff'],
      multiselect: true,
      linkType: 'direct', // preferir link direto (dl.dropboxusercontent.com)
      success: function(files){
        // files: [{link, name, ...}]
        files.forEach(f=>{
          let url = f.link || '';
          // Se vier link compartilh√°vel (?dl=0), troca por ?raw=1
          url = url.replace('?dl=0','?raw=1').replace('&dl=0','&raw=1');
          state.images.push({
            id: uid(),
            url,
            label: (f.name||'Dropbox').replace(/\.[^/.]+$/,''),
            tags: ['dropbox']
          });
        });
        renderThumbs();
        if (state.images.length >= 2 && (!state.leftId || !state.rightId)) {
          state.leftId = state.images[0].id;
          state.rightId = state.images[1].id;
          renderSelectors();
          setPosition(0.5, true);
        } else {
          updateStage();
        }
      },
      cancel: function(){ /* usu√°rio cancelou */ }
    });
  };

})();
</script>
</body>
</html>
